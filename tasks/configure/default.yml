- name: install apache2 packages listed in apache2_module_packages_installed
  apt:
    pkg: "{{ pkg_item }}"
    state: installed
    update_cache: no
  with_items: '{{ apache2_module_packages_installed }}'
  loop_control:
    loop_var: pkg_item
  notify: restart apache2

- name: uninstall apache2 packages listed in apache2_module_packages_removed
  apt:
    pkg: "{{ pkg_item }}"
    state: absent
    update_cache: no
  with_items: '{{ apache2_module_packages_removed }}'
  loop_control:
    loop_var: pkg_item
  notify: restart apache2

- name: template the default vhosts
  template:
    src: "{{ apache2_default_vhost_item }}.j2"
    dest: "/{{ apache2_default_vhost_item }}"
    owner: root
    group: root
    mode: 0600
  with_items:
    - "etc/apache2/sites-available/000-default.conf"
    - "etc/apache2/sites-available/default-ssl.conf"
  loop_control:
    loop_var: apache2_default_vhost_item

- name: ensure the 000-default.conf vhost is enabled
  command: "a2ensite 000-default"
  args:
    creates: "/etc/apache2/sites-enabled/000-default.conf"
  notify: restart apache2

- name: ensure the default-ssl.conf vhost is enabled
  command: "a2ensite default-ssl"
  args:
    creates: "/etc/apache2/sites-enabled/default-ssl.conf"
  notify: restart apache2

- name: disable configured modules
  command: a2dismod -f {{ mod_item }}
  with_items: '{{ apache2_disable_modules }}'
  loop_control:
    loop_var: mod_item
  changed_when: no
  notify: restart apache2

- name: enable configured modules
  command: a2enmod {{ mod_item }}
  with_items: '{{ apache2_enable_modules }}'
  loop_control:
    loop_var: mod_item
  changed_when: no
  notify: restart apache2

- name: configure global webroot for multi-domain LetsEncrypt
  when: apache2_enable_letsencrypt
  copy:
    src: etc/apache2/conf-available/le.conf
    dest: /etc/apache2/conf-available/le.conf
    owner: root
    group: root
    mode: 0644
  notify: restart apache2

- name: enable global webroot for multi-domain LetsEncrypt
  when: apache2_enable_letsencrypt
  command: a2enconf le
  changed_when: no
  notify: restart apache2
